<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid & GridFlex Calculator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
    body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #e8ecf1;
        position: relative;
    }
    .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    .input-section {
        flex: 1;
        min-width: 300px;
        background-color: #f0f4f7;
        padding: 15px;
        border: 2px solid #ccc;
        border-radius: 5px;
    }
    .result-section {
        flex: 2;
        min-width: 300px;
        background-color: #f0f4f7;
        padding: 15px;
        border: 2px solid #ccc;
        border-radius: 5px;
    }
    .input-section h2, .result-section h2 {
        margin-top: 0;
        font-size: 1.5em;
        color: #2c3e50;
    }
    form label {
        display: inline-block;
        width: 120px;
        margin: 5px 0;
    }
    form input, form select {
        padding: 5px;
        margin: 5px 0;
        width: 150px;
    }
    form button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    .result-table {
        width: 100%;
        max-width: 600px;
        border-collapse: collapse;
        margin-top: 15px;
        background-color: #fff9e6;
        border: 1px solid #ccc;
    }
    .result-table th, .result-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
        font-family: 'Courier New', Courier, monospace;
    }
    .result-table th {
        background-color: #e0e0e0;
        color: #2c3e50;
        width: 40%;
    }
    .result-table td {
        width: 60%;
    }
    .plot-container {
        width: 100%;
        height: 800px;
    }
    .logo {
        position: absolute;
        top: 20px;
        right: 20px;
        max-width: 200px; /* Adjusted desktop logo size */
        height: auto;
    }
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }
        .plot-container {
            height: 500px;
        }
        .result-table {
            max-width: 100%;
        }
        .logo {
            max-width: 120px; /* Adjusted mobile logo size */
        }
    }
    </style>
</head>
<body>
    <img src="/static/logo.png" alt="Company Logo" class="logo">
    <h1 style="text-align: center; color: #2c3e50;">Grid & GridFlex Calculator</h1>
    <div class="container">
        <div class="input-section">
            <h2>Input Parameters</h2>
            <form id="calcForm">
                <label for="box_w">Box Width (mm):</label>
                <input type="number" id="box_w" name="box_w" step="any" required><br>
                <label for="box_h">Box Height (mm):</label>
                <input type="number" id="box_h" name="box_h" step="any" required><br>
                <label for="psu_wattage">PSU Wattage (W):</label>
                <input type="number" id="psu_wattage" name="psu_wattage" step="any"><br>
                <label for="psu_max_load">PSU Max Load (%):</label>
                <input type="number" id="psu_max_load" name="psu_max_load" value="80" step="any"><br>
                <label for="panel_type">Panel Type:</label>
                <select id="panel_type" name="panel_type">
                    <option value="Grid v5">Grid v5</option>
                    <option value="GRID v4">Grid v4</option>
                    <option value="GridFlex">GridFlex</option>
                    <option value="GridFlex DW">GridFlex DW</option>
                    <option value="GridFlex RGBW">GridFlex RGBW</option>
                </select><br>
                <button type="submit">Calculate</button>
            </form>
            <h2>Results</h2>
            <table class="result-table" id="result1"></table>
        </div>
        <div class="result-section">
            <h2>Layout</h2>
            <div class="plot-container" id="plot1"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('calcForm');
        const result1 = document.getElementById('result1');
        const plot1 = document.getElementById('plot1');

        function textToTable(text, tableElement) {
            console.log('Raw text input:', text);
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const tbody = document.createElement('tbody');
            const orderedHeadlines = [
                'Panels Used:', 'A:', 'B:', 'C:', 'D:', 
                'Total GridFlex:', 'Full Grid:', 'Cut Grid:',
                'Total Power:', 'PSUs Needed:', 
                'Left Over Margins:', 'Left:', 'Right:', 'Top:', 'Bottom:'
            ];

            lines.forEach(line => {
                const parts = line.split(':').map(part => part.trim());
                if (parts.length >= 2) {
                    const headline = parts[0] + ':';
                    const value = parts.slice(1).join(':').trim();
                    if (orderedHeadlines.includes(headline) && value !== '') {
                        const tr = document.createElement('tr');
                        const th = document.createElement('th');
                        th.textContent = headline;
                        const td = document.createElement('td');
                        td.textContent = value;
                        tr.appendChild(th);
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    }
                }
            });

            console.log('Table rows created:', tbody.innerHTML);
            tableElement.innerHTML = '';
            if (tbody.children.length === 0) {
                tableElement.innerHTML = '<tr><td colspan="2">No data available</td></tr>';
            } else {
                tableElement.appendChild(tbody);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                console.log('Server response:', data);
                if (data.error) {
                    result1.innerHTML = `<tr><td colspan="2">Error: ${data.error}</td></tr>`;
                    Plotly.newPlot(plot1, [], {});
                    return;
                }
                textToTable(data.layout1.text, result1);
                Plotly.newPlot(plot1, [], data.layout1.plot, { responsive: true });
            } catch (error) {
                console.error('Fetch error:', error);
                result1.innerHTML = `<tr><td colspan="2">Error: ${error.message}</td></tr>`;
                Plotly.newPlot(plot1, [], {});
            }
        });
    </script>
</body>
</html>